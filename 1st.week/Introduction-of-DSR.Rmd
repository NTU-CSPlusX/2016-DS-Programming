---
title       : "R 語言翻轉教室"
author      : "Wush Wu"
job         : 國立台灣大學
framework   : io2012-wush
highlighter : highlight.js
hitheme     : zenburn
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
--- &vcenter .largecontent

```{r setup, include=FALSE, cache=FALSE}
library(knitr)
library(magrittr)
library(XML)
library(data.table)
library(dplyr)
library(ggplot2)
library(diagram)

opts_chunk$set(echo = FALSE, cache=FALSE, comment="", 
               cache.path = "cache-Introduction-of-DSR/", 
               dev.args=list(bg="transparent"),
               fig.path = "./assets/fig/introduction-of-dsr")
fig <- function(path, size = 100) {
  sprintf("<img src='assets/img/%s' style='max-width: %d%%;max-height: %d%%'></img>", 
          path, size, size)
}
fig2 <- function(path, size = 100) {
  sprintf("<img src='assets/img/%s' style='width: %d%%'></img>", 
          path, size)
}
bg <- function(path) sprintf("bg:url(assets/img/%s)", path)
sys_name <- Sys.info()["sysname"] %>% tolower
sys_encode <- c("utf8", "utf8", "big5")[pmatch(sys_name, c("linux", "darwin", "windows"))]
sessionInfo() %>% capture.output %>% cat(file = "sessionInfo.log", sep = "\n")
Sys.setlocale(category = "LC_TIME", locale = "en_US.UTF-8")
```

## Wush Wu

- 學經歷
    - 國立台灣大學電機工程學研究所博士生
    - 宇匯知識科技與通用移動的資料科學家
    - Taiwan R User Group 共同創辦人
    - 許多R 套件的貢獻者，例如：digest、knitr、swirl與FeatureHashing

--- &vcenter .largecontent

## 本次課程目錄

- R 的簡介
- R 的傳統用途
- 近代R 的演變
- 安裝R 與Rstudio
- R 的開發環境簡介
- R 的套件系統
- R 語言翻轉教室

--- .dark .segue

## R 簡介

--- &fullimg `r bg("statician_10521919-655x280.jpg")`

*** =pnotes

取自 <http://myfootpath.com/careers/engineering-careers/statistician-careers/>

--- &fullimg `r bg("flights_sml.jpg")`

*** =pnotes

取自 <http://www.r-bloggers.com/mapping-the-worlds-biggest-airlines/>

--- &fullimg `r bg("t134_3ca_lg.jpg")`

*** =pnotes

取自 <http://img.diynetwork.com/DIY/2003/09/18/t134_3ca_med.jpg>

--- &vcenter .largecontent

## R 很容易和其他工具整合

<center>
```{r r-integration, warning=FALSE}
tools <- strsplit("Rcpp,rJava,rpy2,RHadoop,RMySQL,RPostgreSQL,RJDBC,RODBC,ROpenOffice,rredis,rmongodb,RSelenium", ",")[[1]]
freq <- rep(1, length(tools))
pal <- RColorBrewer::brewer.pal(length(tools),"BuGn")
wordcloud::wordcloud(tools, freq, random.color = TRUE, colors = pal)
```
</center>

--- &vcenter .largecontent

## R 很容易擴充和客製化

<br/>

```{r number-of-R-pkgs, warning=FALSE}
if (!file.exists("pkgs.csv")) local({
  ## original idea & report by Henrik Bengtsson at
  ## https://stat.ethz.ch/pipermail/r-devel/2016-February/072388.html
  
  ## This script downloads the list of currently published R packages
  ## from CRAN and also looks at all the archived package versions to
  ## combine these into a list of all R packages ever published on
  ## CRAN with the date of first release.
  
  ## CRAN mirror to use
  CRAN_page <- function(...) {
      file.path('https://cran.rstudio.com/src/contrib', ...)
  }
  
  ## get list of currently available packages on CRAN
  pkgs <- readHTMLTable(readLines(CRAN_page()),
                                  which = 1, stringsAsFactors = FALSE)
  
  ## we love data.table
  setDT(pkgs)
  
  ## drop directories
  pkgs <- pkgs[Size != '-']
  ## drop files that does not seem to be R packages
  pkgs <- pkgs[grep('tar.gz$', Name)]
  
  ## package name should contain only (ASCII) letters, numbers and dot
  pkgs[, name := sub('^([a-zA-Z0-9\\.]*).*', '\\1', Name)]
  
  ## grab date from last modified timestamp
  pkgs[, date := as.POSIXct(`Last modified`, format = '%d-%b-%Y %H:%M')]
  pkgs[, date := as.character(date)]
  
  ## keep date and name
  pkgs <- pkgs[, .(name, date)]
  
  ## list of packages with at least one archived version
  archives <- readHTMLTable(readLines(CRAN_page('Archive')),
                            which = 1, stringsAsFactors = FALSE)
  setDT(archives)
  
  ## keep directories
  archives <- archives[grep('/$', Name)]
  
  ## add packages not found in current list of R packages
  archives[, Name := sub('/$', '', Name)]
  pkgs <- rbind(pkgs,
                archives[!Name %in% pkgs$name, .(name = Name)],
                fill = TRUE)
  
  ## reorder pkg in alphabet order
  setorder(pkgs, name)
  
  ## number of versions released is 1 for published packages
  pkgs[, versions := 0]
  pkgs[!is.na(date), versions := 1]
  
  ## mark archived pacakges
  pkgs[, archived := FALSE]
  pkgs[name %in% archives$Name, archived := TRUE]
  
  ## NA date of packages with archived versions
  pkgs[archived == TRUE, date := NA]
  
  ## lookup release date of first version & number of releases
  pkgs[is.na(date), c('date', 'versions') := {
  
      cat(name, '\n')
  
      ## download archive page
      page <- readLines(CRAN_page('Archive', name))
  
      ## extract date with regexp as HTML parsing can be slow :)
      date <- sub('.*([0-9]{2}-[A-Za-z]{3}-[0-9]{4} [0-9]{2}:[0-9]{2}).*', '\\1', page[10])
  
      ## convert to YYYY-mm-dd format
      date <- as.POSIXct(date, format = '%d-%b-%Y %H:%M')
  
      ## number of previous releases
      archived_versions <- length(page) - 9 - 4
  
      ## return
      list(as.character(date), versions + archived_versions)
  
  }, by = name]
  
  ## rename cols
  setnames(pkgs, 'date', 'first_release')
  
  ## order by date & alphabet
  setorder(pkgs, first_release, name)
  pkgs[, index := .I]
  pkgs[c(250, 500, (1:9)*1000)]
  
  ##                 name       first_release versions archived index
  ##  1:          pls.pcr 2003-03-31 12:44:00       13     TRUE   250
  ##  2:            MEMSS 2005-02-25 08:07:00       12     TRUE   500
  ##  3: signalextraction 2007-03-15 18:50:00        4     TRUE  1000
  ##  4:         ORIClust 2009-09-18 20:18:00        2     TRUE  2000
  ##  5:           MAPLES 2011-04-26 17:36:00        1    FALSE  3000
  ##  6:            Bclim 2012-06-22 05:42:00        3     TRUE  4000
  ##  7:    RadialPlotter 2013-03-21 06:53:00        9     TRUE  5000
  ##  8:             ltsk 2014-02-06 20:35:00        5     TRUE  6000
  ##  9:             matR 2014-10-23 09:50:00        1    FALSE  7000
  ## 10:            CompR 2015-07-01 14:06:00        1    FALSE  8000
  ## 11:       ggcorrplot 2016-01-12 22:12:00        1    FALSE  9000
  
  
  ## store report
  write.csv(pkgs, 'pkgs.csv', row.names = FALSE)
})
## plot trend
pkgs <- read.csv("pkgs.csv")
ggplot(pkgs, aes(as.Date(first_release), index)) +
    geom_line(size = 2) +
    scale_x_date(date_breaks = '2 year', date_labels = '%Y') +
    scale_y_continuous(breaks = seq(0, 9000, 1000)) +
    xlab('') + ylab('') + theme_bw() +
    ggtitle('Number of R packages ever published on CRAN')
```

--- .dark .segue

## R 的傳統用途

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

- 統計很多理論都需要常態分佈
- 但是一組數據真的是常態分佈嗎？

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

<br/>
<br/>

```r
plot(density(x))
```

```{r ks.test1}
x <- c(rnorm(50), rnorm(50, 4))
plot(density(x))
```

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

- 做「是否為常態分佈」的統計檢定？再一行：`shaprio.test(x)`

```{r ks.test2, echo = FALSE, dependson="ks.test"}
shapiro.test(x)
```

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

- 比較兩個數據是不是來自相同的分佈？沒問題

```r
plot(density(x1), xlim = range(c(x1, x2)), main = "Sample PDF")
lines(density(x2), col = 2)
legend("topright", c("x1", "x2"), lty = 1, col = 1:2)
```

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

```{r ks.test3, echo = FALSE}
x1 <- rnorm(50)
x2 <- rt(50, df = 2)
plot(density(x1), xlim = range(c(x1, x2)), main = "Sample PDF")
lines(density(x2), col = 2)
legend("topright", c("x1", "x2"), lty = 1, col = 1:2)
```

--- &vcenter .largecontent

## 範例 - 探索數據的分佈

- 檢定？`ks.test(x1, x2)`

```{r ks.test4, echo = FALSE, dependson="ks.test3"}
ks.test(x1, x2)
```

--- &vcenter .largecontent

## R 是做統計的首選工具之一

- 內建大量統計相關的功能
    - 繪製統計圖表、進行統計檢定...
- 擁有大量第三方開發的統計套件
    - 範例：[supc](https://github.com/wush978/supc) 一個實做(Shiu and Chen 2016)的R 套件

--- &vcenter .largecontent

## 資料科學，不只是統計...

- 收集數據
- 清理數據
- 大量數據
- 分析結果的呈現

--- .dark .segue

## 來自R 社群的貢獻

--- &vcenter .largecontent

## 什麼是社群？

- R Core Team
- Package Developers
- R-User Mailing List

--- &vcenter .largecontent

## 社群的力量

- 工具的可靠性
    - 使用者的人數決定工具的可靠度，付錢的工具不一定可靠（要夠紅）
- 開發的速度
    - 工程師很貴
    - 社群會幫忙的開發與測試（要夠紅）
- 開發的方向
    - 社群會給發展方向的回饋（要夠紅）

--- &vcenter .largecontent

## 範例 - 相關性

- R 擁有許多你想像不到的方式來探索數據
    - 他們都來自於世界各地的貢獻者

--- &vcenter .largecontent

## 範例 - 相關性

<br/>
<br/>

```{r chart.correlation, results = 'hide', warning = FALSE, echo = TRUE}
suppressPackageStartupMessages(library(PerformanceAnalytics))
chart.Correlation(iris[-5], bg=iris$Species, pch=21)
```

--- .largecontent

## 範例 - 經濟學人風格的視覺化

<center>
```{r ggthemes}
library(ggthemes)
dsamp <- diamonds[sample(nrow(diamonds), 1000), ]
q <- (qplot(carat, price, data=dsamp, colour=clarity)
      + ggtitle("Diamonds Are Forever"))

## Standard
q + theme_economist() + scale_colour_economist()
```
</center>

--- .dark .segue

## 近代R 的演變

--- &vcenter .largecontent

## 資料科學不只是分析資料

- 傳統的R對於以下的功能有限：
  - 資料的收集
  - 資料的清理
  - 報表的呈現

--- &vcenter .largecontent

## R Core Team (主導者) v.s. R Packages (社群)

- R Core Team 對新需求的要求很保守
  - 正確姓是絕對的
  - 向下相容: 新功能要能在十年前的電腦上運作
- Community: 那我們就自己寫套件來玩
  - [GitHub · Build software better, together](https://github.com)
  - Hadley降低了寫套件的難度

--- &vcenter .largecontent

## 我們仍然對R Core Team 非常尊敬

- 現在已經有 70000+ 次的更動
- 在2009年10月9日時達到50000次更動 by Prof. Ripley

--- &fullimg `r bg("R-commits.gif")`

*** =pnotes

取自 <https://yihui.name/en/2009/10/50000-revisions-committed-to-r/>

--- &vcenter .largecontent

## 資料的收集

- R 可以寫網路爬蟲
  - httr, xml2, rvest, ...
- R 可以讀取、處理許多資料格式
  - [R Data Import/Export by CRAN](https://cran.r-project.org/doc/manuals/r-release/R-data.html)

--- &vcenter .largecontent

## 常見的處理手法

```{r, echo = FALSE, results = "figure"}
par(mar = c(1, 1, 1, 1), bg = "transparent")
openplotmat()
elpos  <- coordinates (c(1, 1, 1))
fromto <- matrix(c(
  1, 2,
  2, 3
), byrow = TRUE, ncol = 2)
nr     <- nrow(fromto)
arrpos <- matrix(ncol = 2, nrow = nr)
for (i in 1:nr)
 arrpos[i, ] <- straightarrow (to = elpos[fromto[i, 2], ],
                              from = elpos[fromto[i, 1], ],
                              lwd = 2, arr.pos = 0.6, arr.length = 0.5)
textellipse(elpos[1,], 0.3, 0.1,       lab = "抓取網頁資訊",           box.col = "orange",
            shadow.col = "darkgreen", shadow.size = 0.005, cex = 1.5)
textrect   (elpos[2,], 0.3, 0.05,lab = "儲存網頁HTML原始檔到硬碟",     box.col = "orange",
            shadow.col = "darkblue", shadow.size = 0.005, cex = 1.5)
textrect   (elpos[3,], 0.3, 0.05, lab = "分析資料",        box.col = "orange",
            shadow.col = "darkblue", shadow.size = 0.005, cex = 1.5)
```

--- &vcenter .largecontent

## 範例：政府招標資訊網

<br/>

- 中華民國政府電子採購網
    - 利用決標查詢功能來瀏覽與抓取決標資料
    - 時間範圍自2013年10月至2015年11月
    - 一共108360筆決標資料
- 決標資料內容：
    - 機關資料，如：名稱、地址、聯絡人與聯絡電話等
    - 採購資料，如：案號、招標方式、決標方式、標的分類、辦理方式與相關法源依據等
    - 投標廠商，如：廠商統編、名稱、決標金額等
    - 決標品向，如：品向名稱以及得標廠商的相關資料
    - 決標資料，如總決標金額、履約執行機關等

*** =pnotes

<center>`r fig("Selection_031.png")`</center>

--- &vcenter .largecontent

## 範例：政府招標資訊網

- 挖掘公司之間的關係

--- &vcenter .largecontent

